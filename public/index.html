<div id="container"></div>

<script>
  fetch('titanic-passengers.json')
    .then(res => res.json())
    .then(json => json.map((person) => person.fields))
    .then(cleanJson => handleData(cleanJson)) // Call handleData()
    .catch(err => console.log(err))

  // This function handles the loaded JSON data
  function handleData(data) {
    const features = findAllFeatures(data)
    const { categorical, numerical } = categorize(data, features)
    normalizeAll(data)

    const sample = sampleData(data, 0.75)
    const bars = createBars(sample, categorical)
    const histogram = createHistogram(bars)
    container.appendChild(histogram)

    const heightFeature = "fare"
    const colorFeature = "sex"
    showData(bars, heightFeature, colorFeature)

    const key = createKey(categorical[colorFeature])
    container.appendChild(key)
  }

  function findAllFeatures(data) {
    const allFeatures = new Set()

    data.forEach(dataPoint => {
      for (let feature in dataPoint) {
        if (!allFeatures.has(feature)) {
          allFeatures.add(feature)
        }
      }
    })

    return allFeatures
  }

  function categorize(data, features) {
    const categorical = {}
    const numerical = []

    for (let feature of features.values()) {
      const featureArr = data.map(dataRow => dataRow[feature])
      featureSet = new Set(featureArr)

      // determine if categorical data
      if (featureSet.size <= 10) {
        const categories = Array.from(featureSet)
        categorical[feature] = categories
      }

      // determine if numerical data
      for (let dataPoint of featureSet.values()) {
        if (dataPoint) {
          if (typeof dataPoint === "number") {
            numerical.push(feature)
          }
          break
        }
      }
    }

    return { categorical, numerical }
  }

  function sampleData(data, samplePercent = 0.5) {
    const sample = data.reduce((acc, dataPoint) => {
      if (Math.random() < samplePercent) {
        return [...acc, dataPoint]
      }
      return acc
    }, [])

    return sample
  }

  function normalizeArr(dataArr) {
    const maxVal = Math.max(...dataArr)
    const normalArr = dataArr.map(val => val / maxVal * 100)
    return normalArr
  }

  function normalizeAll(data) {
    const allFeatures = findAllFeatures(data)
    const numericalFeatures = new Set()

    for (let i = 0; i < data.length; i++) {
      for (let feature in data[i]) {
        if (typeof data[i][feature] == "number") {
          numericalFeatures.add(feature)
        }
        allFeatures.delete(feature)
      }
      if (allFeatures.size <= 0) {
        break
      }
    }

    for (let feature of numericalFeatures.values()) {
      const featureData = data.map(dataPoint => dataPoint[feature])
      const maxVal = Math.max(...featureData)
      for (let i = 0; i < data.length; i++) {
        data[i][`${feature}Normal`] = data[i][feature] / maxVal * 100
      }
    }
  }

  // From https://stackoverflow.com/questions/11499268/sort-two-arrays-the-same-way
  function sortTwoArrs(sortByArr, arrTwo) {
    // combine
    const objList = []
    for (let i = 0; i < sortByArr.length; i++) {
      objList.push({one: sortByArr[i], two: arrTwo[i]})
    }

    // sort
    objList.sort((a, b) => a.one - b.one)

    // separate
    for (var j = 0; j < objList.length; j++) {
      sortByArr[j] = objList[j].one;
      arrTwo[j] = objList[j].two;
    }

    return {sortedNormalData: sortByArr, sortedPersonColor: arrTwo}
  }

  function createBars(data, categoricalData) {
    const elements = []

    data.forEach((item) => {
      const bar = document.createElement('div')
      bar.style.width = '2px'
      bar.style.margin = '1px'
      bar.style.transition = '3000ms ease-in-out'

      bar.get = (field) => {
        return item[field]
      }

      bar.setHeight = (field) => {
        bar.style.height = item[`${field}Normal`] ? `${item[`${field}Normal`]}%` : `0.5%`
      }

      bar.setColor = (field) => {
        const fieldCategories = categoricalData[field]
        const colorOnCircle = fieldCategories.indexOf(item[field]) / fieldCategories.length * 360
        bar.style.backgroundColor = `hsl(${colorOnCircle}, 80%, 50%)`
      }

      elements.push(bar)
    })

    return elements
  }

  function showData(barElements, fieldHeight, fieldColor) {
    barElements.forEach((bar) => bar.setHeight(fieldHeight))
    barElements.forEach((bar) => bar.setColor(fieldColor))
  }

  function createHistogram(bars) {
    const chart = document.createElement('div')

    chart.style.display = 'flex'
    chart.style.alignItems = 'flex-end'
    chart.style.width = `5000px`
    chart.style.height = `600px`

    bars.forEach((bar) => chart.appendChild(bar))

    return chart
  }

  function createKey(categories) {
    const key = document.createElement('div')

    for (let i = 0; i < categories.length; i++) {
      const color = document.createElement('div')
      key.appendChild(color)

      const colorName = document.createElement('span')
      const colorOnCircle = i / categories.length * 360
      color.appendChild(colorName)
      colorName.innerHTML = `${categories[i]}: `
      colorName.style.fontSize = '20px'
      colorName.style.color = `hsl(${colorOnCircle}, 80%, 50%)`

      const personColorInfo = document.createElement('span')
      color.appendChild(personColorInfo)
      personColorInfo.innerHTML = `${categories[i]}`
      personColorInfo.style.fontSize = '20px'
      personColorInfo.style.color = 'black'
    }

    return key
  }
</script>
